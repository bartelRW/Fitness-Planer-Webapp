@page "/"

@using FitnessPlaner.Components.Pages.ChartComponents
@inject ApplicationDbContext Context

<PageTitle>Home</PageTitle>

<h1>Übersicht</h1>

<div class="row">
    <div class="col mb-4 mt-2">
        <div class="btn-group shadow" role="group">
            <input type="radio" class="btn-check" name="btnradio" id="btn-radio-1" autocomplete="off" checked>
            <label 
                value="@DateOnly.FromDateTime(DateTime.Now.AddMonths(-1))" 
                class="btn btn-outline-primary" 
                @onclick="() => FilterFoodEntriesAsync(DateOnly.FromDateTime(DateTime.Now.AddMonths(-1)))" 
                for="btn-radio-1">1 Monat
            </label>

            <input type="radio" class="btn-check" name="btnradio" id="btn-radio-2" autocomplete="off">
            <label 
                value="@DateOnly.FromDateTime(DateTime.Now.AddMonths(-3))" 
                class="btn btn-outline-primary" 
                @onclick="() => FilterFoodEntriesAsync(DateOnly.FromDateTime(DateTime.Now.AddMonths(-3)))" 
                for="btn-radio-2">3 Monate
            </label>

            <input type="radio" class="btn-check" name="btnradio" id="btn-radio-3" autocomplete="off">
            <label 
                value="@DateOnly.FromDateTime(DateTime.Now.AddMonths(-6))" 
                class="btn btn-outline-primary" 
                @onclick="() => FilterFoodEntriesAsync(DateOnly.FromDateTime(DateTime.Now.AddMonths(-6)))" 
                for="btn-radio-3">6 Monate
            </label>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 col-md-6 mb-4">
        <a href="/mymeals" class="text-decoration-none">
            <div class="card shadow h-100">
                <div class="card-body">
                    <div class="fw-bold text-center p-2">
                        Heutige Mahlzeiten 
                        <span hidden class="text-secondary">@Date.ToString("dddd, dd MMMM yyyy")</span>
                    </div>
                    @if (FoodEntriesToday is not null && FoodEntriesToday.Count > 0)
                    {
                        <div class="table responsive">
                            <table class="table table-striped table-hover">
                                <thead class="fw-bold">
                                    <tr>
                                        <td>Name</td>
                                        <td>
                                            Kalorien
                                            <span class="text-secondary">(kcal)</span>
                                        </td>
                                        <td>
                                            Kohlenhydrate
                                            <span class="text-secondary">(g)</span>
                                        </td>
                                        <td>
                                            Proteine
                                            <span class="text-secondary">(g)</span>
                                        </td>
                                        <td>
                                            Fette
                                            <span class="text-secondary">(g)</span>
                                        </td>
                                    </tr>
                                </thead>
                                <tbody>
                                @foreach (var entry in FoodEntriesToday)
                                {
                                    <tr>
                                        <td>@entry.Name</td>
                                        <td>@entry.Calories</td>
                                        <td>@entry.Carbohydrates</td>
                                        <td>@entry.Protein</td>
                                        <td>@entry.Fats</td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-light" role="alert">
                            <h3>Keine Mahlzeiten eingetragen!</h3>
                            <p>Tragen sie ihre erste Mahlzeit für heute ein</p>
                        </div>
                    }
                </div>
            </div>
        </a>
    </div>
    <div class="col-12 col-md-6 mb-4">
        <a href="/myfolders" class="text-decoration-none">
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex justify-content-center position-relative fw-bold p-2">
                        <i class="bi bi-pin-angle-fill position-absolute start-0 ms-2"></i>
                        Trainingsplan @(PinnedPlan.Name ?? $"- {PinnedPlan.Name}")
                    </div>
                    @if (Exercises is not null && Exercises.Count > 0)
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="fw-bold">
                                    <tr>
                                        <td>Bezeichnung</td>
                                        <td>Sätze</td>
                                        <td>Wiederholungen</td>
                                        <td>Notizen</td>
                                    </tr>
                                </thead>
                                <tbody>
                                @foreach (var exercise in Exercises)
                                {
                                    <tr>
                                        <td>@exercise.Name</td>
                                        <td>@exercise.Sets</td>
                                        <td>@exercise.Repetitions</td>
                                        <td>@exercise.Notes</td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-light" role="alert">
                            <h3>Kein Traingingsplan angeheftet!</h3>
                            <p>Heften sie einen Trainingsplan an, um ein Überblick über ihren aktuellen Plan zu erhalten</p>
                        </div>
                    }
                </div>
            </div>
        </a>
    </div>
</div>

<div class="row">
    <div class="col-12 col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-body">
                <div class="fw-bold text-center">Kalorien</div>
                    @if (CaloriesPoints is not null && CaloriesPoints.Count > 0)
                    {
                        <CascadingValue Name="CaloriesPoints" Value="CaloriesPoints">
                            <CaloriesChart @key="CaloriesPoints" />
                        </CascadingValue>
                    }
                    else
                    {
                        <div><i class="bi bi-database-fill-x"></i> Es sind keine Einträge vorhanden. <a href="/mymeals">Füge eine Mahlzeit hinzu.</a></div>
                    }
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-body">
                <div class="fw-bold text-center">Kohlenhydrate</div>
                @if (CarbsPoints is not null && CarbsPoints.Count > 0)
                {
                    <CascadingValue Name="CarbsPoints" Value="CarbsPoints">
                        <CarbChart @key="CarbsPoints" />
                    </CascadingValue>
                }
                else
                {
                    <div><i class="bi bi-database-fill-x"></i> Es sind keine Einträge vorhanden. <a href="/mymeals">Füge eine Mahlzeit hinzu.</a></div>
                }
            </div>
        </div>
    </div>
</div>


<div class="row">
    <div class="col-12 col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-body">
                <div class="fw-bold text-center">Proteine</div>
                @if (ProteinPoints is not null && ProteinPoints.Count > 0)
                {
                    <CascadingValue Name="ProteinPoints" Value="ProteinPoints">
                        <ProteinChart @key="ProteinPoints" />
                    </CascadingValue>  
                }
                else
                {
                    <div><i class="bi bi-database-fill-x"></i> Es sind keine Einträge vorhanden. <a href="/mymeals">Füge eine Mahlzeit hinzu.</a></div>
                }
            </div>
        </div>
    </div>
    <div class="col-12 col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-body">
                <div class="fw-bold text-center">Fette</div>
                @if (FatsPoints is not null && FatsPoints.Count > 0)
                {
                    <CascadingValue Name="FatsPoints" Value="FatsPoints">
                        <FatsChart @key="FatsPoints" />
                    </CascadingValue>
                }
                else
                {
                    <div><i class="bi bi-database-fill-x"></i> Es sind keine Einträge vorhanden. <a href="/mymeals">Füge eine Mahlzeit hinzu.</a></div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private List<FoodEntry> FoodEntries { get; set; } = new();
    private NutritionGoal NutritionGoal { get; set; } = new();
    private List<FoodEntry> FoodEntriesToday { get; set; } = new();
    private List<Exercise> Exercises { get; set; } = new();
    private Plan PinnedPlan { get; set; } = new();
    private Folder FolderWithPlan { get; set; } = new();

    private List<ChartPoint> CaloriesPoints { get; set; } = new();
    private List<ChartPoint> CarbsPoints { get; set; } = new();
    private List<ChartPoint> FatsPoints { get; set; } = new();
    private List<ChartPoint> ProteinPoints { get; set; } = new();

    private DateOnly Date { get; set; } = DateOnly.FromDateTime(DateTime.Now);
    private DateOnly FilterDate { get; set; } = DateOnly.FromDateTime(DateTime.Now.AddMonths(-1));

    protected override async Task OnInitializedAsync()
    {
        //Load Foodentries from today
        FoodEntriesToday = await Context.FoodEntries.Where(fe => fe.Date == Date).ToListAsync();

        // Load pinned Plan
        PinnedPlan = await Context.Plans
            .Where(p => p.Pinned)
            .Include(p => p.PlanExercises)
            .ThenInclude(pe => pe.Exercise)
            .FirstOrDefaultAsync() ?? new Plan();

        // Load pinned Exercises from Plans
        if (PinnedPlan.PlanExercises is not null)
        {
            Exercises = PinnedPlan.PlanExercises
                .Select(pe => pe.Exercise)
                .Distinct()
                .ToList();
        }

        // Load aggregated FoodEntries from the DB
        FoodEntries = await Context.FoodEntries
            .Where(fe => fe.Date >= FilterDate)
            .GroupBy(fe => fe.Date)
            .Select(g => new FoodEntry
            {
                Date = g.Key,
                Name = "Total",
                Calories = g.Sum(fe => fe.Calories),
                Protein = g.Sum(fe => fe.Protein),
                Carbohydrates = g.Sum(fe => fe.Carbohydrates),
                Fats = g.Sum(fe => fe.Fats)
            })
            .OrderBy(fe => fe.Date)
            .ToListAsync();

        // Load Nutrition Goals
        NutritionGoal = await Context.NutritionGoals.FirstOrDefaultAsync() ?? new NutritionGoal();

        // Create ChartPoints directly from FoodEntries
        CaloriesPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Calories, NutritionGoal = NutritionGoal.Calories }).ToList();
        CarbsPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Carbohydrates, NutritionGoal = NutritionGoal.Carbohydrates }).ToList();
        FatsPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Fats, NutritionGoal = NutritionGoal.Fats }).ToList();
        ProteinPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Protein, NutritionGoal = NutritionGoal.Protein }).ToList();
    }

    private async Task FilterFoodEntriesAsync(DateOnly selectedDate)
    {

        FilterDate = selectedDate;
        var query = Context.FoodEntries.AsQueryable();

        if (FilterDate != DateOnly.FromDateTime(DateTime.MinValue))
            query = query.Where(fe => fe.Date >= FilterDate);

        FoodEntries = await query
            .GroupBy(fe => fe.Date)
            .Select(g => new FoodEntry
            {
                Date = g.Key,
                Name = "Total",
                Calories = g.Sum(fe => fe.Calories),
                Protein = g.Sum(fe => fe.Protein),
                Carbohydrates = g.Sum(fe => fe.Carbohydrates),
                Fats = g.Sum(fe => fe.Fats)
            })
            .OrderBy(fe => fe.Date)
            .ToListAsync();

        // Update ChartPoints
        CaloriesPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Calories, NutritionGoal = NutritionGoal.Calories }).ToList();
        CarbsPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Carbohydrates, NutritionGoal = NutritionGoal.Carbohydrates }).ToList();
        FatsPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Fats, NutritionGoal = NutritionGoal.Fats }).ToList();
        ProteinPoints = FoodEntries.Select(d => new ChartPoint { Date = d.Date, Value = d.Protein, NutritionGoal = NutritionGoal.Protein }).ToList();
    }
}