@page "/myFolders"

@inject ApplicationDbContext Context
@inject IJSRuntime JS
@inject ToastsService ToastService

<PageTitle>Übersicht</PageTitle>

<h1>Übersicht</h1>

<div class="mb-4">
    @if (IsLoading)
    {
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Lädt...</span>
        </div>
    }
    else if (Folders is not null && Folders.Count > 0)
    {
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr class="fw-bold">
                                <td>Name</td>
                                <td>Beschreibung</td>
                                <td class="text-center">Trainingspläne</td>
                                <td class="text-end pe-4">Funktionen</td>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var folder in Folders)
                            {
                                <tr @key="folder.Id">
                                    <td>
                                        <a href="/myplans/@folder.Id" class="text-decoration-none text-black">
                                            <i class="bi bi-folder-fill"></i> @folder.Name
                                        </a>
                                    </td>
                                    <td>@folder.Description</td>
                                    <td class="text-center">@FolderPlans?.Count(fp => fp.FolderId == folder.Id)</td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <a class="btn btn-primary" href="/myplans/@folder.Id">
                                                <i class="bi bi-clipboard2-check-fill"></i>
                                            </a>
                                            <button type="button" class="btn btn-warning"
                                                    @onclick="() => OpenModal(folder)"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#create-edit-modal">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                            <button type="button"
                                                    class="btn btn-danger"
                                                    @onclick="() => ViewFolder = folder"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#delete-modal">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning" role="alert">
            <h3>Keine Ordner vorhanden!</h3>
            <p class="fs-5">Sieht so aus, als hätten Sie noch keinen Ordner erstellt.</p>
        </div>
    }
</div>

<div>
    <button class="btn btn-lg btn-success shadow"
            data-bs-toggle="modal"
            data-bs-target="#create-edit-modal"
            @onclick="() => OpenModal(new Folder())">
        <i class="bi bi-plus-lg"></i>
        <i class="bi bi-folder-fill me-1"></i>
        Ordner hinzufügen
    </button>
</div>

<!-- Create-Edit-Folder-Modal -->
<div class="modal fade" id="create-edit-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">
                    Ordner @(ViewFolder.Id == 0 ? "hinzufügen" : "bearbeiten")
                </h1>
            </div>
            <div class="modal-body">
                <EditForm Model="ViewFolder" OnValidSubmit="CreateorEditViewFolderAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="ViewFolder.Name" class="form-control" placeholder="Neuer Ordner" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Beschreibung <span class="text-secondary">(optional)</span></label>
                        <InputTextArea @bind-Value="ViewFolder.Description" class="form-control" placeholder="Mein Ordner" />
                    </div>

                    <div class="row">
                        <div class="col">
                            <button type="submit" class="btn btn-@(ViewFolder.Id == 0 ? "success" : "warning") w-100">
                                @(ViewFolder.Id == 0 ? "Erstellen" : "Bearbeiten")
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">Abbrechen</button>
                        </div>
                    </div>

                </EditForm>
            </div>
        </div>
    </div>
</div>

<!-- Delete-Modal -->
<div class="modal fade" id="delete-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">Ordner @ViewFolder.Name löschen?</h1>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <button type="button" class="btn btn-danger w-100" @onclick="DeleteFolderAsync" data-bs-dismiss="modal">
                            Löschen
                        </button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<Toasts class="p-3" Messages="ToastService.Messages" AutoHide="true" StackLength="3" Placement="ToastsPlacement.BottomCenter" />

@code {
    private List<Folder>? Folders { get; set; }
    //private Folder Folder { get; set; } = new();
    private Folder ViewFolder { get; set; } = new();

    private List<FolderPlan>? FolderPlans { get; set; }

    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Folders = await Context.Folders.ToListAsync();
        FolderPlans = await Context.FolderPlans.ToListAsync();
        IsLoading = false;
    }

    #region Folder CRUD
    private void OpenModal(Folder folder)
    {
        // Create a temporary clone for editing
        ViewFolder = new Folder
        {
            Id = folder.Id,
            Name = folder.Name,
            Description = folder.Description
        };
    }

    private async Task CreateorEditViewFolderAsync()
    {
        // Edit existing folder
        if (ViewFolder.Id != 0)
        {
            // Load the tracked entity from the database
            var existingFolder = await Context.Folders.FindAsync(ViewFolder.Id);

            if (existingFolder != null)
            {
                // Copy updated values
                existingFolder.Name = ViewFolder.Name;
                existingFolder.Description = ViewFolder.Description;

                ToastService.ShowMessage(ToastType.Warning, "Ordner bearbeitet", "");
            }
        }
        else
        {
            // Add new folder
            Context.Folders.Add(ViewFolder);
            ToastService.ShowMessage(ToastType.Success, "Ordner erstellt", "");
        }

        await Context.SaveChangesAsync();

        await JS.InvokeVoidAsync("closeModal", "create-edit-modal");

        Folders = await Context.Folders.ToListAsync();
    }

    private async Task DeleteFolderAsync()
    {
        if (ViewFolder is not null)
        {
            // Load plans associated with the folder
            var folderPlans = await Context.FolderPlans
                .Where(fp => fp.FolderId == ViewFolder.Id)
                .Include(fp => fp.Plan)
                .ThenInclude(p => p.PlanExercises)
                .ThenInclude(pe => pe.Exercise)
                .ToListAsync();

            // Remove associated plans and their exercises
            foreach (var fp in folderPlans)
            {
                var plan = fp.Plan;

                // Remove Exercises
                foreach (var pe in plan.PlanExercises)
                {
                    Context.Exercises.Remove(pe.Exercise);
                }

                // Remove PlanExercises
                Context.PlanExercises.RemoveRange(plan.PlanExercises);

                // Remove Plans
                Context.Plans.Remove(plan);
            }

            Context.Folders.Remove(ViewFolder);

            await Context.SaveChangesAsync();
        }

        Folders = await Context.Folders.ToListAsync();

        ToastService.ShowMessage(ToastType.Danger, "Ordner gelöscht", "");
    }
    #endregion Folder CRUD
}
