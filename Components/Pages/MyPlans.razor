@page "/myplans/{folderId:int}"

@inject NavigationManager Navigation
@inject ApplicationDbContext Context

<h1>@Folder?.Name > Trainingspläne</h1>

<div class="mb-4">
    @if (IsLoading)
    {
        <div>Lädt...</div>
    }
    else if (Plans is not null && Plans.Count > 0)
    {
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr class="fw-bold">
                                <td>Name</td>
                                <td>Beschreibung</td>
                                <td class="text-end pe-4">Funktionen</td>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var plan in Plans)
                            {
                                <tr>
                                    <td>
                                        <i class="bi bi-clipboard2-check-fill"></i>
                                        @plan.Name
                                    </td>
                                    <td>@plan.Description</td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group" aria-label="Basic mixed styles example">
                                            <button type="button" class="btn btn-primary" @onclick="() => SelectPlanAsync(plan)" data-bs-toggle="modal" data-bs-target="#exercise-modal">
                                                <i class="bi bi-person-arms-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-warning" @onclick="() => Plan = plan" data-bs-toggle="modal" data-bs-target="#create-edit-plan-modal">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger" @onclick="() => Plan = plan" data-bs-toggle="modal" data-bs-target="#delete-modal">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning" role="alert">
            <h3>Keine Trainingspläne vorhanden!</h3>
            <p class="fs-5">Sieht so als hätten Sie noch keinen Trainingsplan erstellt. Klicken sie auf die Schaltfläche "Trainingsplan Hinzufügen" um einen neuen Trainingsplan zu erstellen</p>
        </div>
    }
</div>

<div>
    <button class="btn btn-lg btn-success shadow" data-bs-toggle="modal" data-bs-target="#create-edit-plan-modal" @onclick="() => Plan = new()">
        <i class="bi bi-plus-lg"></i>
        <i class="bi bi-clipboard2-check-fill me-1"></i>
        Trainingsplan hinzufügen
    </button>
</div>

<!-- Create-Edit-Plan-Modal -->
<div class="modal fade" id="create-edit-plan-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Trainingsplan @(Plan.Id == 0 ? "hinzufügen" : "bearbeiten")</h1>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <EditForm Model="Plan" Context="FormCtx" OnValidSubmit="CreateOrEditPlanAsync">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <InputText @bind-Value="Plan.Name" class="form-control" placeholder="Neuer Trainingsplan" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Beschreibung <span class="text-secondary">(optional)</span></label>
                                <InputTextArea @bind-Value="Plan.Description" class="form-control" placeholder="Mein Trainingsplan" />
                            </div>

                            <div class="row">
                                <div class="col">
                                    <button type="submit" class="btn btn-@(Plan.Id == 0 ? "success" : "warning") w-100" data-bs-dismiss="modal">
                                        @(Plan.Id == 0 ? "Erstellen" : "Bearbeiten")
                                    </button>
                                </div>
                                <div class="col">
                                    <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal"> Abbrechen </button>
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete-Modal -->
<div class="modal fade" id="delete-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Trainingsplan @Plan.Name löschen?</h1>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <button type="button" class="btn btn-danger w-100" @onclick="DeletePlanAsync" data-bs-dismiss="modal">Löschen</button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise-Modal -->
<div class="modal fade" id="exercise-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">@Plan.Name</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (ExercisesForPlan is not null && ExercisesForPlan.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr class="fw-bold">
                                    <td>Name</td>
                                    <td>Sätze</td>
                                    <td>Wiederholungen</td>
                                    <td>Notizen</td>
                                    <td class="text-end pe-4">Funktionen</td>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exercise in ExercisesForPlan)
                                {
                                    <tr>
                                        <td>@exercise.Name</td>
                                        <td>@exercise.Sets</td>
                                        <td>@exercise.Repetitions</td>
                                        <td>@exercise.Notes</td>
                                        <td class="text-end">
                                            <button class="btn btn-danger" @onclick="async () => await RemoveExerciseAsync(exercise)">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning" role="alert">
                        <h5>Füge deine erste Übung hinzu</h5>
                    </div>
                }

                <button class="btn btn-lg btn-success shadow" data-bs-target="#add-exercise-modal" data-bs-toggle="modal">
                    <i class="bi bi-plus-lg"></i>
                    <i class="bi bi-person-arms-up"></i>
                    Übung hinzufügen
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add-Exercise-Modal -->
<div class="modal fade" id="add-exercise-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" >Übung hinzufügen</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="Exercise" Context="FormCtx" OnValidSubmit="AddExerciseAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="Exercise.Name" class="form-control" placeholder="Kreuzheben" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sätze</label>
                        <InputNumber @bind-Value="Exercise.Sets" class="form-control" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Wiederholungen</label>
                        <InputNumber @bind-Value="Exercise.Repetitions" class="form-control" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notizen <span class="text-secondary">(optional)</span></label>
                        <InputTextArea @bind-Value="Exercise.Notes" class="form-control" />
                    </div>

                    <div class="row">
                        <div class="col">
                            <button type="submit" class="btn btn-success w-100" data-bs-target="#exercise-modal" data-bs-toggle="modal">
                                Übung hinzufügen
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal"> Abbrechen </button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

<!-- Toast-Messages -->
<Toasts class="p-3" Messages="ToastMessages" AutoHide="true" StackLength="3" Placement="ToastsPlacement.BottomCenter" />

@code {
    [Parameter]
    public int FolderId { get; set; }

    private Folder Folder { get; set; } = new();
    private List<Plan>? Plans { get; set; }
    private Plan Plan { get; set; } = new();
    private List<Exercise>? ExercisesForPlan { get; set; }
    private Exercise Exercise { get; set; } = new();

    private bool IsLoading = true;

    #region Lifecycle Methods
    protected override async Task OnInitializedAsync()
    {
        Folder = await Context.Folders.FindAsync(FolderId);

        // Redirect to NotFound if given ID is invalid
        if (Folder == null)
        {
            Navigation.NavigateTo("/notfound");
            return;
        }

        Plans = await Context.FolderPlans.Where(fp => fp.FolderId == FolderId).Select(fp => fp.Plan!).ToListAsync();

        // Show loading message to avoid flickering
        IsLoading = false;
    }
    #endregion

    #region CRUD operations for Plans
    private async Task SelectPlanAsync(Plan selectedPlan)
    {
        Plan = selectedPlan;

        ExercisesForPlan = await Context.PlanExercises.Where(pe => pe.PlanId == Plan.Id).Select(pe => pe.Exercise!).ToListAsync();

        StateHasChanged();
    }

    private async Task CreateOrEditPlanAsync()
    {
        if (Plans is null) return;

        // Check if plan already exists
        var existingPlan = await Context.Plans.Include(p => p.FolderPlans).FirstOrDefaultAsync(p => p.Id == Plan.Id);

        if (existingPlan != null)
        {
            // Update existing plan
            existingPlan.Name = Plan.Name;
            Context.Plans.Update(existingPlan);

            // Check if Folder-Plan mapping already exists
            if (!existingPlan.FolderPlans.Any(fp => fp.FolderId == Folder.Id))
            {
                existingPlan.FolderPlans.Add(new FolderPlan
                {
                    FolderId = Folder.Id,
                    PlanId = existingPlan.Id
                });
            }
        }
        else
        {
            // New Plan
            Context.Plans.Add(Plan);
            await Context.SaveChangesAsync();

            // Add Folder-Plan mapping
            Context.FolderPlans.Add(new FolderPlan
            {
                FolderId = Folder.Id,
                PlanId = Plan.Id
            });
            await Context.SaveChangesAsync();
        }

        // Refresh list
        Plans = await Context.FolderPlans.Where(fp => fp.FolderId == FolderId).Select(fp => fp.Plan!).ToListAsync();
        Plan = new();

        ShowMessage(ToastType.Success, "Trainingsplan erstellt", "");
    }

    private async Task DeletePlanAsync()
    {
        if (Plans is null || Plan.Id == 0) return;

        // Get existing plan with FolderPlan mappings
        var existingPlan = await Context.Plans.Include(p => p.FolderPlans).FirstOrDefaultAsync(p => p.Id == Plan.Id);

        if (existingPlan != null)
        {
            // Remove FolderPlan mappings first
            Context.FolderPlans.RemoveRange(existingPlan.FolderPlans);

            // Then remove the plan itself
            Context.Plans.Remove(existingPlan);

            await Context.SaveChangesAsync();
        }

        // Refresh list
        Plans = await Context.FolderPlans.Where(fp => fp.FolderId == FolderId).Select(fp => fp.Plan!).ToListAsync();
        Plan = new();

        ShowMessage(ToastType.Danger, "Trainingsplan gelöscht", "");
    }
    #endregion CRUD operations for Plans

    #region CRUD operations for Exercises
    private async Task AddExerciseAsync()
    {
        if (Plan.Id == 0) return;

        // Add exercise to database
        Context.Exercises.Add(Exercise);
        await Context.SaveChangesAsync();

        // Add Plan-Exercise mapping
        Context.PlanExercises.Add(new PlanExercise
        {
            PlanId = Plan.Id,
            ExerciseId = Exercise.Id
        });
        await Context.SaveChangesAsync();

        // Refresh exercise list
        ExercisesForPlan = await Context.PlanExercises.Where(pe => pe.PlanId == Plan.Id).Select(pe => pe.Exercise!).ToListAsync();
        Exercise = new();

        ShowMessage(ToastType.Success, "Übung hinzugefügt", "");
    }

    private async Task RemoveExerciseAsync(Exercise exercise)
    {
        if (exercise is null || exercise.Id == 0) return;

        // Get existing plan with FolderPlan mappings
        var existingExercise = await Context.Exercises.Include(p => p.PlanExercises).FirstOrDefaultAsync(p => p.Id == exercise.Id);

        if (existingExercise != null)
        {
            // Remove FolderPlan mappings first
            Context.PlanExercises.RemoveRange(existingExercise.PlanExercises);

            // Then remove the plan itself
            Context.Exercises.Remove(existingExercise);

            await Context.SaveChangesAsync();
        }

        // Refresh list
        ExercisesForPlan = await Context.PlanExercises.Where(pe => pe.PlanId == Plan.Id).Select(pe => pe.Exercise!).ToListAsync();

        ShowMessage(ToastType.Danger, "Übung entfernt", "");
    }
    #endregion CRUD operations for Exercises

    List<ToastMessage> ToastMessages = new List<ToastMessage>();
    private void ShowMessage(ToastType toastType, string title, string message) => ToastMessages.Add(CreateToastMessage(toastType, title, message));
    private ToastMessage CreateToastMessage(ToastType toastType, string title, string message) => new ToastMessage
    {
        Type = toastType,
        Title = title,
        HelpText = $"{DateTime.Now:HH:mm}",
        Message = message,
    };
}
