@page "/myplans/{folderId:int}"
@using System.Text

@inject NavigationManager Navigation
@inject ApplicationDbContext Context
@inject ToastsService ToastService
@inject IJSRuntime JS

<PageTitle>Pläne</PageTitle>

<h1>
    <a class="text-decoration-none text-black" href="/myfolders">@Folder.Name</a> > Trainingspläne
</h1>

<div class="mb-4">
    @if (!string.IsNullOrWhiteSpace(Folder?.Description))
    {
        <div class="card mb-3 shadow">
            <div class="card-body">
                <i class="bi bi-info-square-fill text-primary"></i>
                @Folder?.Description
            </div>
        </div>
    }

    @if (IsLoading)
    {
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Lädt...</span>
        </div>
    }
    else if (Plans is not null && Plans.Count > 0)
    {
        <div class="card shadow">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr class="fw-bold">
                                <td>Name</td>
                                <td>Beschreibung</td>
                                <td class="text-center">
                                    Dauer <span class="text-secondary">(Min)</span>
                                </td>
                                <td class="text-end pe-4">Funktionen</td>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var plan in Plans)
                            {
                                <tr @key="plan.Id">
                                    <td @onclick="() => SelectPlanAsync(plan)" data-bs-toggle="modal" data-bs-target="#exercise-modal">
                                        <span class="btn">
                                            <i class="bi bi-clipboard2-check-fill"></i>
                                            @plan.Name
                                        </span>
                                    </td>
                                    <td>@plan.Description</td>
                                    <td class="text-center">@plan.Duration</td>
                                    <td class="text-end">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-primary" @onclick="() => SelectPlanAsync(plan)" data-bs-toggle="modal" data-bs-target="#exercise-modal">
                                                <i class="bi bi-person-arms-up"></i>
                                            </button>
                                            <button class="btn btn-success" @onclick="() => DownloadCSVAsync(plan)">
                                                <i class="bi bi-filetype-csv"></i>
                                            </button>
                                            <button type="button" class="btn btn-warning" @onclick="() => OpenModal(plan)" data-bs-toggle="modal" data-bs-target="#create-edit-plan-modal">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger" @onclick="() => Plan = plan" data-bs-toggle="modal" data-bs-target="#delete-modal">
                                                <i class="bi bi-trash3-fill"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-light" role="alert">
            <h3>Keine Trainingspläne vorhanden!</h3>
            <p class="fs-5">Sieht so als hätten Sie noch keinen Trainingsplan erstellt. Klicken sie auf die Schaltfläche "Trainingsplan Hinzufügen" um einen neuen Trainingsplan zu erstellen</p>
        </div>
    }
</div>

<div>
    <button class="btn btn-lg btn-success shadow" data-bs-toggle="modal" data-bs-target="#create-edit-plan-modal" @onclick="() => ViewPlan = new()">
        <i class="bi bi-plus-lg"></i>
        <i class="bi bi-clipboard2-check-fill me-1"></i>
        Trainingsplan hinzufügen
    </button>
</div>

<!-- Create-Edit-Plan-Modal -->
<div class="modal fade" id="create-edit-plan-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5">Trainingsplan @(Plan.Id == 0 ? "hinzufügen" : "bearbeiten")</h1>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <EditForm Model="ViewPlan" OnValidSubmit="CreateOrEditPlanAsync">
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <InputText @bind-Value="ViewPlan.Name" class="form-control" placeholder="Neuer Trainingsplan" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Dauer <span class="text-secondary">(Minuten)</span></label>
                                <InputNumber @bind-Value="ViewPlan.Duration" class="form-control" min="0" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Beschreibung <span class="text-secondary">(optional)</span></label>
                                <InputTextArea @bind-Value="ViewPlan.Description" class="form-control" placeholder="Mein Trainingsplan" />
                            </div>

                            <div class="row">
                                <div class="col">
                                    <button type="submit" class="btn btn-@(ViewPlan.Id == 0 ? "success" : "warning") w-100">
                                        @(ViewPlan.Id == 0 ? "Erstellen" : "Bearbeiten")
                                    </button>
                                </div>
                                <div class="col">
                                    <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal"> Abbrechen </button>
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete-Modal -->
<div class="modal fade" id="delete-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">Trainingsplan @Plan.Name löschen?</h1>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col">
                        <button type="button" class="btn btn-danger w-100" @onclick="DeletePlanAsync" data-bs-dismiss="modal">Löschen</button>
                    </div>
                    <div class="col">
                        <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">abbrechen</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exercise-Modal -->
<div class="modal fade" id="exercise-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">@Plan.Name</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (ExercisesForPlan is not null && ExercisesForPlan.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr class="fw-bold">
                                    <td>Name</td>
                                    <td class="text-center">Sätze</td>
                                    <td class="text-center">Wiederholungen</td>
                                    <td>Notizen</td>
                                    <td></td>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var exercise in ExercisesForPlan)
                                {
                                    <tr>
                                        <td>@exercise.Name</td>
                                        <td class="text-center">@exercise.Sets</td>
                                        <td class="text-center">@exercise.Repetitions</td>
                                        <td>@exercise.Notes</td>
                                        <td class="text-end">
                                            <button class="btn" @onclick="async () => await RemoveExerciseAsync(exercise)">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-light" role="alert">
                        <h5>Füge deine erste Übung hinzu</h5>
                    </div>
                }

                <button class="btn btn-lg btn-success shadow me-2" data-bs-target="#add-exercise-modal" data-bs-toggle="modal">
                    <i class="bi bi-plus-lg"></i>
                    <i class="bi bi-person-arms-up"></i>
                    Übung hinzufügen
                </button>
                <button class="btn btn-lg btn-@(Plan.Pinned ? "secondary" : "outline-secondary") shadow" @onclick="PinPlanAsync">
                    <i class="bi bi-pin-angle-fill"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add-Exercise-Modal -->
<div class="modal fade" id="add-exercise-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">Übung hinzufügen</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="Exercise" OnValidSubmit="AddExerciseAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="Exercise.Name" class="form-control" placeholder="Kreuzheben" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sätze</label>
                        <InputNumber @bind-Value="Exercise.Sets" class="form-control" min="0" max="1000" required/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Wiederholungen</label>
                        <InputNumber @bind-Value="Exercise.Repetitions" class="form-control" min="0" max="1000" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notizen <span class="text-secondary">(optional)</span></label>
                        <InputTextArea @bind-Value="Exercise.Notes" class="form-control" />
                    </div>

                    <div class="row">
                        <div class="col">
                            <button type="submit" class="btn btn-success w-100">
                                Übung hinzufügen
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal"> Abbrechen </button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

<!-- Toast-Messages -->
<Toasts class="p-3" Messages="ToastService.Messages" AutoHide="true" StackLength="3" Placement="ToastsPlacement.BottomCenter" />

@code {
    [Parameter]
    public int FolderId { get; set; }

    private Folder Folder { get; set; } = new();
    private List<Plan>? Plans { get; set; }
    private Plan Plan { get; set; } = new();
    private Plan ViewPlan { get; set; } = new();
    private List<Exercise>? ExercisesForPlan { get; set; }
    private Exercise Exercise { get; set; } = new();

    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        Folder = await Context.Folders.FindAsync(FolderId);

        // Redirect to NotFound if given ID is invalid
        if (Folder == null)
        {
            Navigation.NavigateTo("/notfound");
            return;
        }

        Plans = await Context.FolderPlans
            .Where(fp => fp.FolderId == FolderId)
            .Select(fp => fp.Plan!)
            .ToListAsync();

        // Show loading message to avoid flickering
        IsLoading = false;
    }

    #region CRUD operations for Plans
    private async Task SelectPlanAsync(Plan selectedPlan)
    {
        Plan = selectedPlan;
        ExercisesForPlan = await Context.PlanExercises
            .Where(pe => pe.PlanId == Plan.Id)
            .Select(pe => pe.Exercise!)
            .ToListAsync();
    }

    private void OpenModal(Plan plan)
    {
        // Create temporary clone for editing
        ViewPlan = new Plan
        {
            Id = plan.Id,
            Name = plan.Name,
            Duration = plan.Duration,
            Description = plan.Description
        };

        // Keep original for reference if needed
        Plan = plan;
    }

    private async Task CreateOrEditPlanAsync()
    {
        if (Plans is null) return;

        if (ViewPlan.Id != 0)
        {
            // Load tracked entity from DB
            var existingPlan = await Context.Plans
                .Include(p => p.FolderPlans)
                .FirstOrDefaultAsync(p => p.Id == ViewPlan.Id);

            if (existingPlan is not null)
            {
                // Copy updated values
                existingPlan.Name = ViewPlan.Name;
                existingPlan.Duration = ViewPlan.Duration;
                existingPlan.Description = ViewPlan.Description;

                ToastService.ShowMessage(ToastType.Warning, "Trainingsplan bearbeitet", "");

                // Add Folder mapping if missing
                if (!existingPlan.FolderPlans.Any(fp => fp.FolderId == Folder.Id))
                {
                    existingPlan.FolderPlans.Add(new FolderPlan
                    {
                        FolderId = Folder.Id,
                        PlanId = existingPlan.Id
                    });
                }
            }
        }
        else
        {
            // Add new plan
            Context.Plans.Add(ViewPlan);
            await Context.SaveChangesAsync();

            // Add Folder-Plan mapping
            Context.FolderPlans.Add(new FolderPlan
            {
                FolderId = Folder.Id,
                PlanId = ViewPlan.Id
            });
            await Context.SaveChangesAsync();

            ToastService.ShowMessage(ToastType.Success, "Trainingsplan erstellt", "");
        }

        // Refresh list
        Plans = await Context.FolderPlans
            .Where(fp => fp.FolderId == Folder.Id)
            .Select(fp => fp.Plan!)
            .ToListAsync();

        // Close modal via JS
        await JS.InvokeVoidAsync("closeModal", "create-edit-plan-modal");
    }

    private async Task DeletePlanAsync()
    {
        if (Plans is null || Plan.Id == 0) return;

        // Get existing plan with FolderPlan mappings
        var existingPlan = await Context.Plans
            .Include(p => p.FolderPlans)
            .FirstOrDefaultAsync(p => p.Id == Plan.Id);

        if (existingPlan != null)
        {
            // Load all PlanExercises with Exercises
            var planExercises = await Context.PlanExercises
                .Where(pe => pe.PlanId == existingPlan.Id)
                .Include(pe => pe.Exercise)
                .ToListAsync();

            // Remove Exercises first
            foreach (var pe in planExercises)
            {
                Context.Exercises.Remove(pe.Exercise);
            }

            // Remove PlanExercise mappings
            Context.PlanExercises.RemoveRange(planExercises);

            // Remove FolderPlan mappings
            Context.FolderPlans.RemoveRange(existingPlan.FolderPlans);

            // Remove the plan itself
            Context.Plans.Remove(existingPlan);

            await Context.SaveChangesAsync();
        }

        // Refresh list
        Plans = await Context.FolderPlans
            .Where(fp => fp.FolderId == FolderId)
            .Select(fp => fp.Plan!)
            .ToListAsync();
        Plan = new();

        ToastService.ShowMessage(ToastType.Danger, "Trainingsplan gelöscht", "");
    }

    private async Task PinPlanAsync()
    {
        if (Plan.Id == 0) return;
        // Load tracked entity from DB
        var existingPlan = await Context.Plans.FindAsync(Plan.Id);
        if (existingPlan is not null)
        {
            // Unpin other plans
            var pinnedPlans = await Context.Plans.Where(p => p.Pinned).ToListAsync();
            foreach(var pinnedPlan in pinnedPlans)
            {
                if (pinnedPlan.Id != existingPlan.Id)
                    pinnedPlan.Pinned = false;
            }

            existingPlan.Pinned = !existingPlan.Pinned;
            await Context.SaveChangesAsync();
            Plan.Pinned = existingPlan.Pinned;
            ToastService.ShowMessage(ToastType.Primary, existingPlan.Pinned ? "Trainingsplan angeheftet" : "Trainingsplan gelöst", "");
        }
    }

    private async Task DownloadCSVAsync(Plan plan)
    {
        if (plan == null)
            return;

        // Get exercises for the plan
        var exercisesForPlan = await Context.PlanExercises
            .Where(pe => pe.PlanId == plan.Id)
            .Select(pe => pe.Exercise!)
            .ToListAsync();

        var csv = "Name;Saetze;Wiederholungen;Notizen\n" +
          string.Join("\n", exercisesForPlan.Select(e => $"{e.Name};{e.Sets};{e.Repetitions};{e.Notes}"));

        // Convert to stream
        var bytes = Encoding.UTF8.GetBytes(csv.ToString());
        var stream = new MemoryStream(bytes);

        // Trigger download via javaScript
        using var streamRef = new DotNetStreamReference(stream);
        await JS.InvokeVoidAsync("downloadFileFromStream", $"trainingsplan_{plan.Name.ToLower()}.csv", streamRef);
    }

    #endregion CRUD operations for Plans

    #region CRUD operations for Exercises
    private async Task AddExerciseAsync()
    {
        if (Plan.Id == 0) return;

        // Add exercise to database
        Context.Exercises.Add(Exercise);
        await Context.SaveChangesAsync();

        // Add Plan-Exercise mapping
        Context.PlanExercises.Add(new PlanExercise
        {
            PlanId = Plan.Id,
            ExerciseId = Exercise.Id
        });
        await Context.SaveChangesAsync();

        // Refresh exercise list
        ExercisesForPlan = await Context.PlanExercises
            .Where(pe => pe.PlanId == Plan.Id)
            .Select(pe => pe.Exercise!)
            .ToListAsync();

        // Switch back to previous modal
        await JS.InvokeVoidAsync("closeModal", "add-exercise-modal");
        await JS.InvokeVoidAsync("openModal", "exercise-modal");

        Exercise = new();

        ToastService.ShowMessage(ToastType.Success, "Übung hinzugefügt", "");
    }

    private async Task RemoveExerciseAsync(Exercise exercise)
    {
        if (exercise is null || exercise.Id == 0) return;

        // Get existing plan with FolderPlan mappings
        var existingExercise = await Context.Exercises
            .Include(p => p.PlanExercises)
            .FirstOrDefaultAsync(p => p.Id == exercise.Id);

        if (existingExercise != null)
        {
            // Remove FolderPlan mappings first
            Context.PlanExercises.RemoveRange(existingExercise.PlanExercises);

            // Then remove the plan itself
            Context.Exercises.Remove(existingExercise);

            await Context.SaveChangesAsync();
        }

        // Refresh list
        ExercisesForPlan = await Context.PlanExercises
            .Where(pe => pe.PlanId == Plan.Id)
            .Select(pe => pe.Exercise!)
            .ToListAsync();

        ToastService.ShowMessage(ToastType.Danger, "Übung entfernt", "");
    }
    #endregion CRUD operations for Exercises
}
