@page "/mymeals"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject ApplicationDbContext Context
@inject ToastsService ToastService
@inject IJSRuntime JS
@inject ProtectedSessionStorage SessionStorage

<PageTitle>Mahlzeiten</PageTitle>

@{
    var nutritionItems = new[]
    {
        new {
            Name = "Kalorien",
            Value = FoodEntrySum.Calories,
            Goal = NutritionGoalView.Calories,
            Icon = "bi-lightning-fill",
        },
        new {
            Name = "Kohlenhydrate",
            Value = FoodEntrySum.Carbohydrates,
            Goal = NutritionGoalView.Carbohydrates,
            Icon = "bi-flower1",
        },
        new {
            Name = "Proteine",
            Value = FoodEntrySum.Protein,
            Goal = NutritionGoalView.Protein,
            Icon = "bi-egg-fried",
        },
        new {
            Name = "Fett",
            Value = FoodEntrySum.Fats,
            Goal = NutritionGoalView.Fats,
            Icon = "bi-droplet-fill",
        }
    };
}

<h1>Meine Mahlzeiten</h1>

<div class="card shadow mb-4">
    <div class="card-body">
        <h4 class="mb-3"> 
            Ernährungsziel -   
            @Date.ToString("dddd, dd MMMM yyyy")
        </h4>
        <div class="row">
            <div class="row">
                @foreach (var item in nutritionItems)
                {
                    var status = GetNutritionStatus(item.Value, item.Goal);

                    <div class="col-12 col-md mb-3">
                        <Tooltip Title="@status.Message" Color="@status.TooltipColor"  Placement="TooltipPlacement.Bottom">
                            <div class="card h-100">
                                <div class="card-body bg-@status.Color-subtle shadow d-flex align-items-start gap-2">
                                    <i class="bi @status.Icon position-absolute top-0 end-0 me-2 mt-2 fs-5"></i>
                                    <i class="bi @item.Icon fs-1"></i>
                                    <div class="flex-grow-1">
                                        <b>@item.Name:</b>
                                        <div>@item.Value/@item.Goal @(item.Name == "Kalorien" ? "kcal" : "g")</div>
                                        <div class="progress mt-1" role="progressbar">
                                            <div class="progress-bar progress-bar-striped bg-@status.Color"
                                                 style="width:@(Math.Round((item.Value * 100) / item.Goal))%">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </Tooltip>
                    </div>
                }
            </div>

            <div class="col-12 mt-3">
                <button class="btn btn-warning shadow" @onclick="() => OpenNutrtionGoalModal(NutritionGoalView)" data-bs-toggle="modal" data-bs-target="#edit-modal">
                    <i class="bi bi-pencil-fill"></i>
                    Ernährungsziel bearbeiten
                </button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <h4 class="mb-3">
            Mahlzeitenerfassung
        </h4>

        <!-- Prev-and-Next-buttons -->
        <div class="row mb-4">
            <div class="col-4 text-start">
                <button class="btn btn-outline-primary w-100 shadow" @onclick="() => ChangeDateAsync(0)">
                    <i class="bi bi-caret-left-fill"></i>
                    Vorheriger Tag
                </button>
            </div>
            <div class="col-4 text-center">
                <InputDate 
                    class="form-control px-4 text-center border-primary fw-bold" 
                    @bind-Value="Date" 
                    @onfocusout="() => ChangeDateAsync(null)" />
            </div>
            <div class="col-4 text-end">
                <button class="btn btn-outline-primary w-100 shadow" @onclick="() => ChangeDateAsync(1)" disabled="@(Date == DateOnly.FromDateTime(DateTime.Now) ? true : false)">
                    <i class="bi bi-caret-right-fill"></i>
                    Nächster Tag
                </button>
            </div>
        </div>

        <!--Meals lists-->
        <div class="row">
            <div class="col">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Meine Mahlzeiten</strong>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#add-foodentry-modal">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                    @if (FoodEntries is not null && FoodEntries.Count > 0)
                    {
                        <ol class="list-group list-group-flush">
                            @foreach (var foodEntry in FoodEntries)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-start" @key="foodEntry.Id">
                                    <div class="ms-2 me-auto">
                                        <div class="fw-bold">@foodEntry.Name</div>
                                        <div class="d-flex w-100">
                                            <div class="pe-2 flex-grow-1">Kalorien: @foodEntry.Calories Kcal</div><div class="vr"></div>
                                            <div class="px-2 flex-grow-1">Kohlenhydrate: @foodEntry.Carbohydrates g</div><div class="vr"></div>
                                            <div class="px-2 flex-grow-1">Proteine: @foodEntry.Protein g</div><div class="vr"></div>
                                            <div class="px-2 flex-grow-1">Fett: @foodEntry.Fats g</div>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm" @onclick="() => RemoveFoodEntryAsync(foodEntry)">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </li>
                            }
                        </ol>
                    }
                    else
                    {
                        <div class="alert alert-light m-2" role="alert">
                            Keine Mahlzeiten aufgezeichnet
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Gesamt</strong>
                    </div>
                    <div class="ms-2 me-auto p-2">
                        <div class="d-flex w-100">
                            <div class="pe-2 flex-grow-1">Kalorien: @FoodEntrySum.Calories Kcal</div><div class="vr"></div>
                            <div class="px-2 flex-grow-1">Kohlenhydrate: @FoodEntrySum.Carbohydrates g</div><div class="vr"></div>
                            <div class="px-2 flex-grow-1">Proteine: @FoodEntrySum.Protein g</div><div class="vr"></div>
                            <div class="px-2 flex-grow-1">Fett: @FoodEntrySum.Fats g</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit-NutritionGoal-Modal -->
<div class="modal fade" id="edit-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">
                    Ernährungsziel bearbeiten
                </h1>
            </div>
            <div class="modal-body">
                <!-- EditForm bindet nun an das temporäre Bearbeitungsobjekt -->
                <EditForm Model="EditingnutritionGoal" OnValidSubmit="EditNutritionGoal">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">Kalorien</label>
                        <InputNumber @bind-Value="EditingnutritionGoal.Calories" class="form-control" min="0" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Kohlenhydrate</label>
                        <InputNumber @bind-Value="EditingnutritionGoal.Carbohydrates" class="form-control" min="0" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Proteine</label>
                        <InputNumber @bind-Value="EditingnutritionGoal.Protein" class="form-control" min="0" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fett</label>
                        <InputNumber @bind-Value="EditingnutritionGoal.Fats" class="form-control" min="0" required />
                    </div>

                    <div class="row">
                        <div class="col">
                            <button type="submit" class="btn btn-warning w-100">
                                Bearbeiten
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">Abbrechen</button>
                        </div>
                    </div>

                </EditForm>
            </div>
        </div>
    </div>
</div>


<!-- Add-FoodEntry-Modal -->
<div class="modal fade" id="add-foodentry-modal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fw-bold fs-5">
                    Mahlzeit hinzufügen
                </h1>
            </div>
            <div class="modal-body">
                <EditForm Model="FoodEntry" FormName="FoodEntryForm" OnValidSubmit="AddFoodEntryAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="FoodEntry.Name" class="form-control" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Kalorien</label>
                        <InputNumber @bind-Value="FoodEntry.Calories" class="form-control" min="0" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Kohlenhydrate</label>
                        <InputNumber @bind-Value="FoodEntry.Carbohydrates" class="form-control" min="0" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Proteine</label>
                        <InputNumber @bind-Value="FoodEntry.Protein" class="form-control" min="0" required />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Fett</label>
                        <InputNumber @bind-Value="FoodEntry.Fats" class="form-control" min="0" required />
                    </div>

                    <div class="row">
                        <div class="col">
                            <button type="submit" class="btn btn-success w-100">
                                Hinzufügen
                            </button>
                        </div>
                        <div class="col">
                            <button type="button" class="btn btn-danger w-100" data-bs-dismiss="modal">Abbrechen</button>
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

<Toasts class="p-3" Messages="ToastService.Messages" AutoHide="true" StackLength="1" Placement="ToastsPlacement.BottomCenter" />

@code {
    private DateOnly Date { get; set; } = DateOnly.FromDateTime(DateTime.Now);

    private NutritionGoal NutritionGoalView { get; set; } = new();
    private NutritionGoal EditingnutritionGoal { get; set; } = new();

    List<FoodEntry> FoodEntries { get; set; } = new();
    FoodEntry FoodEntry { get; set; } = new();
    FoodEntry FoodEntrySum { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        var nutritionGoal = await Context.NutritionGoals.FirstOrDefaultAsync();

        if (nutritionGoal == null)
        {
            // Create new NutritionGoal if it does not exist
            nutritionGoal = new NutritionGoal();
            Context.NutritionGoals.Add(nutritionGoal);
            await Context.SaveChangesAsync();
        }

        // Set ViewModel for UI
        NutritionGoalView = nutritionGoal;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // On first render, load the stored date from session storage
        if (firstRender)
        {
            var stored = await SessionStorage.GetAsync<string>("Date");

            if (stored.Success && DateOnly.TryParse(stored.Value, out var parsed))
            {
                Date = parsed;
            }

            // Load FoodEntries for the selected date
            FoodEntries = await Context.FoodEntries
                .Where(f => f.Date == Date)
                .ToListAsync();

            FoodEntrySum = UpdateSum(FoodEntries);

            StateHasChanged();
        }
    }

    private void OpenNutrtionGoalModal(NutritionGoal nutritionGoalCopy)
    {
        // Create a temporary clone for editing
        EditingnutritionGoal = new NutritionGoal
        {
            Id = nutritionGoalCopy.Id,
            Calories = nutritionGoalCopy.Calories,
            Carbohydrates = nutritionGoalCopy.Carbohydrates,
            Protein = nutritionGoalCopy.Protein,
            Fats = nutritionGoalCopy.Fats
        };
    }

    private async Task EditNutritionGoal()
    {
        // Load the tracked entity from the database
        var nutritionGoalFromDb = Context.NutritionGoals.First();

        if (nutritionGoalFromDb is not null)
        {
            // Copy updated values
            nutritionGoalFromDb.Calories = EditingnutritionGoal.Calories;
            nutritionGoalFromDb.Carbohydrates = EditingnutritionGoal.Carbohydrates;
            nutritionGoalFromDb.Protein = EditingnutritionGoal.Protein;
            nutritionGoalFromDb.Fats = EditingnutritionGoal.Fats;

            ToastService.ShowMessage(ToastType.Warning, "Ernährungsziel bearbeitet", "");

            // Update the view model
            NutritionGoalView = nutritionGoalFromDb;
        }

        await Context.SaveChangesAsync();

        await JS.InvokeVoidAsync("closeModal", "edit-modal");
    }

    private async Task AddFoodEntryAsync()
    {
        // Add the new FoodEntry
        FoodEntry.Date = Date;
        Context.FoodEntries.Add(FoodEntry);
        await Context.SaveChangesAsync();

        // UI update and message
        ToastService.ShowMessage(ToastType.Success, "Mahlzeit hinzugefügt", "");
        FoodEntry = new();
        await JS.InvokeVoidAsync("closeModal", "add-foodentry-modal");
        FoodEntries = await Context.FoodEntries.Where(f => f.Date == Date).ToListAsync();
        FoodEntrySum = UpdateSum(FoodEntries);
    }

    private async Task RemoveFoodEntryAsync(FoodEntry foodEntry)
    {
        // Remove the FoodEntry
        Context.FoodEntries.Remove(foodEntry);
        await Context.SaveChangesAsync();

        // UI update and message
        FoodEntries = await Context.FoodEntries.Where(f => f.Date == Date).ToListAsync();
        FoodEntrySum = UpdateSum(FoodEntries);
        ToastService.ShowMessage(ToastType.Danger, "Mahlzeit entfernt", "");
    }

    private async Task ChangeDateAsync(int? direction)
    {
        // 0 = previous day, 1 = next day
        if (direction.HasValue)
        {
            Date = direction == 0 ? Date.AddDays(-1) : Date.AddDays(1);
        }

        // Load FoodEntries for the new date
        if (Date >= DateOnly.FromDateTime(DateTime.Now.AddYears(-1)) && Date <= DateOnly.FromDateTime(DateTime.Now))
        {
            FoodEntries = await Context.FoodEntries.Where(f => f.Date == Date).ToListAsync();
        }
        else
        {
            ToastService.ShowMessage(ToastType.Warning, "Das Datum liegt außerhalb des gültigen Bereichs", "");
            Date = DateOnly.FromDateTime(DateTime.Now);
        }

        // Update sums
        FoodEntrySum = UpdateSum(FoodEntries);

        // Store selected date in session storage
        await SessionStorage.SetAsync("Date", Date);
    }

    private FoodEntry UpdateSum(List<FoodEntry> foodEntries)
    {
        // Sum all nutrition values
        return new FoodEntry
        {
            Calories = foodEntries.Sum(f => f.Calories),
            Protein = foodEntries.Sum(f => f.Protein),
            Carbohydrates = foodEntries.Sum(f => f.Carbohydrates),
            Fats = foodEntries.Sum(f => f.Fats)
        };
    }

    private NutritionStatus GetNutritionStatus(double total, double goal)
    {
        // Calculate difference and percent
        double difference = total - goal;
        double diffPercent = difference / goal; // fraction (0.1 = 10%)

        NutritionStatus status = new();
        status.Percentage = diffPercent;

        if (total < goal)  // Below target
        {
            status.Color = "primary";
            status.TooltipColor = TooltipColor.Primary;
            status.Icon = "bi-info-circle-fill";
            status.Message = "Du hast dein Tagesziel noch nicht erreicht";
        }
        else if (total == goal || diffPercent <= 0.10) // Exactly on or slightly above target
        {
            status.Color = "success";
            status.TooltipColor = TooltipColor.Success;
            status.Icon = "bi-star-fill";
            status.Message = "Info: Du hast dein Tagesziel erreicht!";
        }
        else if (diffPercent <= 0.30) // Moderately above (10–30%)
        {
            status.Color = "warning";
            status.TooltipColor = TooltipColor.Warning;
            status.Icon = "bi-exclamation-circle-fill";
            status.Message = "Warnung: Du bist leicht über deinem Tagesziel";
        }
        else if (diffPercent <= 0.50)  // Strongly above (30–50%)
        {
            status.Color = "danger";
            status.TooltipColor = TooltipColor.Danger;
            status.Icon = "bi-exclamation-triangle-fill";
            status.Message = "Achtung: Du hast dein Tagesziel stark überschritten";
        }

        // Extremely above (>50%)
        else
        {
            status.Color = "danger";
            status.TooltipColor = TooltipColor.Danger;
            status.Icon = "bi-exclamation-octagon-fill";
            status.Message = "Achtung: Du hast dein Tagesziel extem stark überschritten";
        }

        return status;
    }
}